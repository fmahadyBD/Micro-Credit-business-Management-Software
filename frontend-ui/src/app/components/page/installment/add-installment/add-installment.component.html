<main class="main-content" [class.collapsed]="isSidebarCollapsed">
  <div class="container-fluid mt-4">
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white">
        <h4 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Add New Installment</h4>
      </div>

      <div class="card-body">
        <!-- Success Message -->
        <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show">
          <i class="fas fa-check-circle me-2"></i>{{ successMessage }}
          <button type="button" class="btn-close" (click)="successMessage = null"></button>
        </div>

        <!-- Error Message -->
        <div *ngIf="error" class="alert alert-danger alert-dismissible fade show">
          <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
          <button type="button" class="btn-close" (click)="error = null"></button>
        </div>

        <form (ngSubmit)="onSubmit()" #installmentForm="ngForm">
          <div class="row">
            <!-- Left Column -->
            <div class="col-md-6">
              <!-- Product Search -->
              <div class="mb-3">
                <label class="form-label">
                  <i class="fas fa-box me-2"></i>Product *
                </label>
                <div class="position-relative">
                  <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search product by name or category..."
                      [(ngModel)]="productSearchTerm" (input)="onProductSearch()" (focus)="onProductSearch()"
                      name="productSearch" [disabled]="loadingProducts" required>
                    <button *ngIf="selectedProduct" class="btn btn-outline-danger" type="button"
                      (click)="clearProduct()" title="Clear selection">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>

                  <!-- Product Dropdown -->
                  <div *ngIf="showProductDropdown" class="dropdown-menu show w-100 shadow-lg"
                    style="max-height: 300px; overflow-y: auto; position: absolute; z-index: 1000;">
                    <button *ngFor="let product of filteredProducts" type="button"
                      class="dropdown-item d-flex justify-content-between align-items-start"
                      (click)="selectProduct(product)">
                      <div class="flex-grow-1">
                        <div class="fw-bold">{{ product.name }}</div>
                        <small class="text-muted">
                          <i class="fas fa-tag me-1"></i>{{ product.category }}
                        </small>
                        <small class="text-success ms-2">
                          <i class="fas fa-money-bill me-1"></i>৳{{ product.price }}
                        </small>
                        <!-- Show member from DTO fields OR nested object -->
                        <small *ngIf="product.whoRequestName || product.whoRequest?.name" class="text-info d-block mt-1">
                          <i class="fas fa-user me-1"></i>{{ product.whoRequestName || product.whoRequest?.name }} 
                          ({{ product.whoRequestPhone || product.whoRequest?.phone }})
                        </small>
                      </div>
                    </button>
                    <div *ngIf="filteredProducts.length === 0" class="dropdown-item text-muted">
                      No products found
                    </div>
                  </div>

                  <!-- Selected Product Display -->
                  <div *ngIf="selectedProduct" class="alert alert-info mt-2 py-2 px-3">
                    <small>
                      <strong>Selected:</strong> {{ selectedProduct.name }}<br>
                      <i class="fas fa-tag me-1"></i>{{ selectedProduct.category }} |
                      <i class="fas fa-money-bill me-1"></i>৳{{ selectedProduct.price }}
                      <span *ngIf="selectedProduct.whoRequestName || selectedProduct.whoRequest?.name" class="d-block mt-1">
                        <i class="fas fa-user me-1"></i>Member: 
                        {{ selectedProduct.whoRequestName || selectedProduct.whoRequest?.name }} 
                        ({{ selectedProduct.whoRequestPhone || selectedProduct.whoRequest?.phone }})
                      </span>
                    </small>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="totalAmount" class="form-label">Total Amount *</label>
                    <input type="number" class="form-control" id="totalAmount" name="totalAmount"
                      [(ngModel)]="installment.totalAmountOfProduct" required min="0.01" step="0.01"
                      #totalAmount="ngModel">
                    <div *ngIf="totalAmount.invalid && (totalAmount.dirty || totalAmount.touched)" class="text-danger">
                      <small *ngIf="totalAmount.errors?.['required']">Total amount is required</small>
                      <small *ngIf="totalAmount.errors?.['min']">Amount must be positive</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="otherCost" class="form-label">Other Cost</label>
                    <input type="number" class="form-control" id="otherCost" name="otherCost"
                      [(ngModel)]="installment.otherCost" min="0" step="0.01">
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="advancedPaid" class="form-label">Advanced Payment *</label>
                    <input type="number" class="form-control" id="advancedPaid" name="advancedPaid"
                      [(ngModel)]="installment.advanced_paid" required min="0" step="0.01" #advancedPaid="ngModel">
                    <div *ngIf="advancedPaid.invalid && (advancedPaid.dirty || advancedPaid.touched)"
                      class="text-danger">
                      <small *ngIf="advancedPaid.errors?.['required']">Advanced payment is required</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="installmentMonths" class="form-label">Installment Months *</label>
                    <input type="number" class="form-control" id="installmentMonths" name="installmentMonths"
                      [(ngModel)]="installment.installmentMonths" required min="1" max="60"
                      #installmentMonths="ngModel">
                    <div *ngIf="installmentMonths.invalid && (installmentMonths.dirty || installmentMonths.touched)"
                      class="text-danger">
                      <small *ngIf="installmentMonths.errors?.['required']">Months is required</small>
                      <small *ngIf="installmentMonths.errors?.['min'] || installmentMonths.errors?.['max']">Must be
                        between 1-60</small>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="interestRate" class="form-label">Interest Rate (%) *</label>
                    <input type="number" class="form-control" id="interestRate" name="interestRate"
                      [(ngModel)]="installment.interestRate" required min="0" max="100" step="0.01"
                      #interestRate="ngModel">
                    <div *ngIf="interestRate.invalid && (interestRate.dirty || interestRate.touched)"
                      class="text-danger">
                      <small *ngIf="interestRate.errors?.['required']">Interest rate is required</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="status" class="form-label">Status *</label>
                    <select class="form-select" id="status" name="status" [(ngModel)]="installment.status" required
                      #status="ngModel">
                      <option value="PENDING">Pending</option>
                      <option value="ACTIVE">Active</option>
                      <option value="COMPLETED">Completed</option>
                      <option value="OVERDUE">Overdue</option>
                      <option value="CANCELLED">Cancelled</option>
                      <option value="DEFAULTED">Defaulted</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Column -->
            <div class="col-md-6">
              <!-- Member Display (Auto-populated from Product) -->
              <div class="mb-3">
                <label class="form-label">
                  <i class="fas fa-user me-2"></i>Member (Auto-selected from Product)
                </label>
                
                <!-- Show detailed member info when available -->
                <div *ngIf="selectedMember && memberName && memberName !== 'No member assigned'" class="alert alert-info py-2 px-3">
                  <small>
                    <div class="fw-bold">{{ selectedMember.name }}</div>
                    <div class="mt-1">
                      <i class="fas fa-phone me-1"></i>{{ selectedMember.phone }}
                    </div>
                    <div class="mt-1" *ngIf="selectedMember.nidCardNumber">
                      <i class="fas fa-id-card me-1"></i>NID: {{ selectedMember.nidCardNumber }}
                    </div>
                    <div class="mt-1" *ngIf="selectedMember.village && selectedMember.zila">
                      <i class="fas fa-map-marker-alt me-1"></i>{{ selectedMember.village }}, {{ selectedMember.zila }}
                    </div>
                    <div class="mt-2 text-muted">
                      <i class="fas fa-info-circle me-1"></i>Auto-selected from product
                    </div>
                  </small>
                </div>
                
                <div *ngIf="!memberName || memberName === 'No member assigned'" class="alert alert-warning py-2 px-3">
                  <small><i class="fas fa-info-circle me-1"></i>Select a product to see member information</small>
                </div>
              </div>

              <!-- Agent Search -->
              <div class="mb-3">
                <label class="form-label">
                  <i class="fas fa-user-tie me-2"></i>Agent (Delivery Agent) *
                </label>
                <div class="position-relative">
                  <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search by name, phone, or NID..."
                      [(ngModel)]="agentSearchTerm" (input)="onAgentSearch()" (focus)="onAgentSearch()"
                      name="agentSearch" [disabled]="loadingAgents" required>
                    <button *ngIf="selectedAgent" class="btn btn-outline-danger" type="button" (click)="clearAgent()"
                      title="Clear selection">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>

                  <!-- Agent Dropdown -->
                  <div *ngIf="showAgentDropdown" class="dropdown-menu show w-100 shadow-lg"
                    style="max-height: 300px; overflow-y: auto; position: absolute; z-index: 1000;">
                    <button *ngFor="let agent of filteredAgents" type="button"
                      class="dropdown-item d-flex justify-content-between align-items-start"
                      (click)="selectAgent(agent)">
                      <div class="flex-grow-1">
                        <div class="fw-bold">{{ agent.name }}</div>
                        <small class="text-muted">
                          <i class="fas fa-phone me-1"></i>{{ agent.phone }}
                        </small>
                        <small class="text-muted ms-2">
                          <i class="fas fa-id-card me-1"></i>{{ agent.nidCard }}
                        </small>
                      </div>
                      <span class="badge" [class.bg-success]="agent.status === 'Active'"
                        [class.bg-secondary]="agent.status !== 'Active'">
                        {{ agent.status }}
                      </span>
                    </button>
                    <div *ngIf="filteredAgents.length === 0" class="dropdown-item text-muted">
                      No agents found
                    </div>
                  </div>

                  <!-- Selected Agent Display -->
                  <div *ngIf="selectedAgent" class="alert alert-info mt-2 py-2 px-3">
                    <small>
                      <strong>Selected:</strong> {{ selectedAgent.name }}<br>
                      <i class="fas fa-phone me-1"></i>{{ selectedAgent.phone }} |
                      <i class="fas fa-map-marker-alt me-1"></i>{{ selectedAgent.village }}, {{ selectedAgent.zila }}
                    </small>
                  </div>
                </div>
              </div>

              <!-- Installment Images -->
              <div class="mb-3">
                <label class="form-label">Installment Images</label>
                <div class="border rounded p-3 text-center">
                  <input type="file" class="form-control" id="images" (change)="onFileSelected($event)" multiple
                    accept="image/*">
                  <small class="text-muted">Select multiple images (JPEG, PNG, etc.)</small>

                  <!-- Image Previews -->
                  <div *ngIf="imagePreviews.length > 0" class="mt-3">
                    <h6>Selected Images:</h6>
                    <div class="d-flex flex-wrap gap-3">
                      <div *ngFor="let preview of imagePreviews; let i = index" class="position-relative">
                        <img [src]="preview" alt="Preview"
                          style="width: 100px; height: 100px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd;">
                        <button type="button"
                          class="btn btn-sm btn-danger position-absolute top-0 end-0 translate-middle"
                          style="border-radius: 50%;" (click)="removeFile(selectedFiles[i])">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Calculated Summary -->
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">Payment Summary</h6>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Total with Interest:</span>
                    <strong>৳{{ calculateTotalWithInterest() | number:'1.2-2' }}</strong>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Monthly Payment:</span>
                    <strong class="text-success">৳{{ calculateMonthlyPayment() | number:'1.2-2' }}</strong>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span>Remaining Amount:</span>
                    <strong class="text-danger">৳{{ calculateRemainingAmount() | number:'1.2-2' }}</strong>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="d-flex gap-2 mt-3">
            <button type="submit" class="btn btn-success"
              [disabled]="!installmentForm.form.valid || loading || !selectedProduct || !selectedAgent">
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
              <i class="fas fa-save me-2"></i>Add Installment
            </button>
            <button type="button" class="btn btn-secondary" (click)="cancel()">
              <i class="fas fa-times me-2"></i>Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>