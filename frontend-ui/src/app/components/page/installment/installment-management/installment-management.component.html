<main class="main-content" [class.collapsed]="isSidebarCollapsed">
  <div class="container-fluid mt-4">
    <!-- Header -->
    <div class="page-header mb-4">
      <div class="row align-items-center">
        <div class="col">
          <h1 class="page-title">
            <i class="fas fa-file-invoice-dollar me-3"></i>Installment Management
          </h1>
          <p class="text-muted mb-0">Manage all customer installments and payment schedules</p>
        </div>
        <div class="col-auto">
          <button class="btn btn-primary" (click)="addNewInstallment()">
            <i class="fas fa-plus-circle me-2"></i>Add New Installment
          </button>
        </div>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
      <div class="col-xl-3 col-md-6">
        <div class="card summary-card bg-primary text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4 class="mb-0">{{ installments.length }}</h4>
                <p class="mb-0">Total Installments</p>
              </div>
              <div class="icon-wrapper bg-primary-light">
                <i class="fas fa-file-invoice text-primary"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6">
        <div class="card summary-card bg-success text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4 class="mb-0">{{ getInstallmentsByStatus('ACTIVE') }}</h4>
                <p class="mb-0">Active</p>
              </div>
              <div class="icon-wrapper bg-success-light">
                <i class="fas fa-check-circle text-success"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6">
        <div class="card summary-card bg-warning text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4 class="mb-0">{{ getInstallmentsByStatus('PENDING') }}</h4>
                <p class="mb-0">Pending</p>
              </div>
              <div class="icon-wrapper bg-warning-light">
                <i class="fas fa-clock text-warning"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6">
        <div class="card summary-card bg-danger text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4 class="mb-0">{{ getInstallmentsByStatus('OVERDUE') }}</h4>
                <p class="mb-0">Overdue</p>
              </div>
              <div class="icon-wrapper bg-danger-light">
                <i class="fas fa-exclamation-triangle text-danger"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Search and Filter Card -->
    <div class="card search-card mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label">Search</label>
            <div class="input-group">
              <input type="text" class="form-control" placeholder="Search by member, product, phone..."
                [(ngModel)]="searchTerm" (keyup.enter)="searchInstallments()">
              <button class="btn btn-outline-primary" type="button" (click)="searchInstallments()">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
          <div class="col-md-3">
            <label class="form-label">Status</label>
            <select class="form-select" [(ngModel)]="statusFilter" (change)="applyFilters()">
              <option value="ALL">All Status</option>
              <option value="PENDING">Pending</option>
              <option value="ACTIVE">Active</option>
              <option value="COMPLETED">Completed</option>
              <option value="OVERDUE">Overdue</option>
              <option value="CANCELLED">Cancelled</option>
              <option value="DEFAULTED">Defaulted</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" [(ngModel)]="dateFilter" (change)="applyFilters()">
          </div>
          <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100" (click)="clearFilters()">
              <i class="fas fa-refresh me-2"></i>Clear
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Alerts -->
    <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show">
      <i class="fas fa-check-circle me-2"></i>{{ successMessage }}
      <button type="button" class="btn-close" (click)="successMessage = null"></button>
    </div>

    <div *ngIf="error" class="alert alert-danger alert-dismissible fade show">
      <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
      <button type="button" class="btn-close" (click)="error = null"></button>
    </div>

    <!-- Installments Table -->
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-list me-2"></i>Installments List
          <span class="badge bg-primary ms-2">{{ filteredInstallments.length }}</span>
        </h5>
      </div>
      <div class="card-body">
        <!-- Loading State -->
        <div *ngIf="loading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-muted">Loading installments...</p>
        </div>

        <!-- Empty State -->
        <div *ngIf="!loading && filteredInstallments.length === 0" class="text-center py-5">
          <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">No installments found</h5>
          <p class="text-muted">Try adjusting your search or filters</p>
          <button class="btn btn-primary" (click)="clearFilters()">
            <i class="fas fa-refresh me-2"></i>Clear Filters
          </button>
        </div>

        <!-- Installments Table -->
        <div *ngIf="!loading && filteredInstallments.length > 0" class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Member</th>
                <th>Product</th>
                <th>Total Amount</th>
                <th>Paid</th>
                <th>Progress</th>
                <th>Months</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let installment of paginatedInstallments" class="installment-item">
                <td>
                  <strong>#{{ installment.id }}</strong>
                </td>
                <td>
                  <div class="fw-semibold">{{ installment.member.name }}</div>
                  <small class="text-muted">{{ installment.member.phone }}</small>
                </td>
                <td>
                  <div class="fw-semibold">{{ installment.product.name }}</div>
                  <small class="text-muted">{{ installment.product.category }}</small>
                </td>
                <td>
                  <div class="fw-semibold">{{ formatCurrency(installment.totalAmountWithInterest) }}</div>
                  <small class="text-muted">Monthly: {{ formatCurrency(installment.monthlyInstallmentAmount) }}</small>
                </td>
                <td>
                  <div class="fw-semibold text-success">{{ formatCurrency(installment.advanced_paid) }}</div>
                  <small class="text-muted">Remaining: {{ formatCurrency(installment.needPaidAmount) }}</small>
                </td>
                <td>
                  <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-gradient" 
                         [style.width.%]="calculateProgress(installment)"
                         [title]="calculateProgress(installment) + '%'">
                    </div>
                  </div>
                  <small class="text-muted">{{ calculateProgress(installment) | number:'1.0-0' }}%</small>
                </td>
                <td>
                  <span class="badge bg-info">{{ installment.installmentMonths }} months</span>
                </td>
                <td>
                  <span [class]="getStatusBadgeClass(installment.status)">
                    {{ installment.status }}
                  </span>
                </td>
                <td>
                  <small>{{ formatDate(installment.createdTime) }}</small>
                </td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" 
                            (click)="openEditModal(installment)"
                            title="Edit Installment">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-info"
                            (click)="viewInstallmentDetails(installment)"
                            title="View Details">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-danger"
                            (click)="openDeleteModal(installment)"
                            title="Delete Installment">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>

          <!-- Pagination -->
          <nav *ngIf="totalPages > 1" class="d-flex justify-content-between align-items-center mt-4">
            <div class="text-muted">
              Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to 
              {{ Math.min(currentPage * itemsPerPage, filteredInstallments.length) }} of 
              {{ filteredInstallments.length }} entries
            </div>
            <ul class="pagination mb-0">
              <li class="page-item" [class.disabled]="currentPage === 1">
                <a class="page-link" (click)="previousPage()">
                  <i class="fas fa-chevron-left"></i>
                </a>
              </li>
              
              <li *ngFor="let page of getPaginationArray()" 
                  class="page-item" 
                  [class.active]="currentPage === page">
                <a class="page-link" (click)="goToPage(page)">{{ page }}</a>
              </li>
              
              <li class="page-item" [class.disabled]="currentPage === totalPages">
                <a class="page-link" (click)="nextPage()">
                  <i class="fas fa-chevron-right"></i>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div *ngIf="showEditModal" class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5)">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="fas fa-edit me-2"></i>Edit Installment #{{ editingInstallment?.id }}
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeEditModal()"></button>
        </div>
        <div class="modal-body">
          <form #editForm="ngForm">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Total Amount *</label>
                  <input type="number" class="form-control" 
                         [(ngModel)]="editFormData.totalAmountOfProduct" 
                         name="totalAmountOfProduct" required min="0.01" step="0.01">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Other Cost</label>
                  <input type="number" class="form-control" 
                         [(ngModel)]="editFormData.otherCost" 
                         name="otherCost" min="0" step="0.01">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Advanced Paid *</label>
                  <input type="number" class="form-control" 
                         [(ngModel)]="editFormData.advanced_paid" 
                         name="advanced_paid" required min="0" step="0.01">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Installment Months *</label>
                  <input type="number" class="form-control" 
                         [(ngModel)]="editFormData.installmentMonths" 
                         name="installmentMonths" required min="1" max="60">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Interest Rate (%) *</label>
                  <input type="number" class="form-control" 
                         [(ngModel)]="editFormData.interestRate" 
                         name="interestRate" required min="0" max="100" step="0.01">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Status *</label>
                  <select class="form-select" [(ngModel)]="editFormData.status" name="status" required>
                    <option value="PENDING">Pending</option>
                    <option value="ACTIVE">Active</option>
                    <option value="COMPLETED">Completed</option>
                    <option value="OVERDUE">Overdue</option>
                    <option value="CANCELLED">Cancelled</option>
                    <option value="DEFAULTED">Defaulted</option>
                  </select>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeEditModal()">
            <i class="fas fa-times me-2"></i>Cancel
          </button>
          <button type="button" class="btn btn-primary" 
                  (click)="updateInstallment()" 
                  [disabled]="saving || !editForm.valid">
            <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
            <i *ngIf="!saving" class="fas fa-save me-2"></i>{{ saving ? 'Updating...' : 'Update Installment' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div *ngIf="showDeleteModal" class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5)">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">
            <i class="fas fa-exclamation-triangle me-2"></i>Confirm Delete
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeDeleteModal()"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this installment?</p>
          <div class="alert alert-warning">
            <strong>Installment #{{ deletingInstallment?.id }}</strong><br>
            Member: {{ deletingInstallment?.member?.name }}<br>
            Product: {{ deletingInstallment?.product?.name }}<br>
            Amount: {{ formatCurrency(deletingInstallment?.totalAmountWithInterest) }}
          </div>
          <p class="text-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            This action cannot be undone.
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">
            <i class="fas fa-times me-2"></i>Cancel
          </button>
          <button type="button" class="btn btn-danger" 
                  (click)="deleteInstallment()" 
                  [disabled]="deleting">
            <span *ngIf="deleting" class="spinner-border spinner-border-sm me-2"></span>
            <i *ngIf="!deleting" class="fas fa-trash me-2"></i>{{ deleting ? 'Deleting...' : 'Delete Installment' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</main>